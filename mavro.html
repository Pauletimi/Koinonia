<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mavro - Koinonia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC9ikNYt8QnD6FHm1MOq11HB0kTP_X8qNQ",
            authDomain: "wealth-club-65dab.firebaseapp.com",
            projectId: "wealth-club-65dab",
            storageBucket: "wealth-club-65dab.firebasestorage.app",
            messagingSenderId: "906138407714",
            appId: "1:906138407714:web:78e002acd44d2af326cb7b",
            measurementId: "G-8H8CZ65956"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let allTransactions = [];

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            const userData = localStorage.getItem('currentUser');
            if (!userData) {
                window.location.href = 'login.html';
                return;
            }

            currentUser = JSON.parse(userData);
            document.getElementById('userName').textContent = currentUser.name;
            loadMavroData();
            loadTransactions();
        });

        // Load Mavro data
        async function loadMavroData() {
            if (!currentUser) return;

            try {
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const balance = userData.mavroBalance || 0;
                    const joinDate = new Date(userData.joinDate);
                    const monthsActive = Math.floor((new Date() - joinDate) / (1000 * 60 * 60 * 24 * 30));
                    const totalGrowth = balance * Math.pow(1.3, monthsActive) - balance;

                    document.getElementById('currentBalance').textContent = `$${balance.toFixed(2)}`;
                    document.getElementById('totalGrowth').textContent = `$${totalGrowth.toFixed(2)}`;
                    document.getElementById('monthlyRate').textContent = '30%';
                    document.getElementById('monthsActive').textContent = monthsActive;
                }
            } catch (error) {
                console.error('Error loading Mavro data:', error);
            }
        }

        // Load transactions
        async function loadTransactions() {
            try {
                const q = query(
                    collection(db, 'mavroTransactions'),
                    where('userId', '==', currentUser.uid),
                    orderBy('date', 'desc')
                );
                const querySnapshot = await getDocs(q);
                
                allTransactions = [];
                querySnapshot.forEach((doc) => {
                    allTransactions.push({ id: doc.id, ...doc.data() });
                });

                displayTransactions(allTransactions);
            } catch (error) {
                console.error('Error loading transactions:', error);
                // If orderBy fails, try without it
                const q = query(
                    collection(db, 'mavroTransactions'),
                    where('userId', '==', currentUser.uid)
                );
                const querySnapshot = await getDocs(q);
                
                allTransactions = [];
                querySnapshot.forEach((doc) => {
                    allTransactions.push({ id: doc.id, ...doc.data() });
                });

                // Sort manually
                allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                displayTransactions(allTransactions);
            }
        }

        // Display transactions
        function displayTransactions(transactions) {
            const container = document.getElementById('transactionsList');
            container.innerHTML = '';

            if (transactions.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No transactions found.</p>';
                return;
            }

            transactions.forEach(transaction => {
                const transactionElement = createTransactionElement(transaction);
                container.appendChild(transactionElement);
            });
        }

        // Create transaction element
        function createTransactionElement(transaction) {
            const div = document.createElement('div');
            div.className = 'bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow';
            
            const typeColors = {
                'bonus': 'green',
                'provide': 'blue',
                'get': 'purple',
                'growth': 'yellow'
            };
            
            const typeIcons = {
                'bonus': 'üéÅ',
                'provide': 'ü§ù',
                'get': 'üôè',
                'growth': 'üìà'
            };
            
            const color = typeColors[transaction.type] || 'gray';
            const icon = typeIcons[transaction.type] || 'üí∞';
            
            div.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex items-start space-x-4">
                        <div class="w-12 h-12 bg-${color}-100 rounded-full flex items-center justify-center">
                            <span class="text-2xl">${icon}</span>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-1">${transaction.description}</h4>
                            <p class="text-sm text-gray-600 mb-2">${transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)} Transaction</p>
                            <p class="text-xs text-gray-500">${new Date(transaction.date).toLocaleDateString('en-US', { 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-${color}-600 text-lg">+$${transaction.amount.toFixed(2)}</p>
                        <span class="inline-block px-2 py-1 text-xs rounded-full bg-${color}-100 text-${color}-800">
                            ${transaction.status || 'Completed'}
                        </span>
                    </div>
                </div>
            `;
            
            return div;
        }

        // Filter transactions
        window.filterTransactions = function(type) {
            const buttons = document.querySelectorAll('.filter-btn');
            buttons.forEach(btn => btn.classList.remove('bg-blue-500', 'text-white'));
            buttons.forEach(btn => btn.classList.add('bg-gray-200', 'text-gray-700'));
            
            event.target.classList.remove('bg-gray-200', 'text-gray-700');
            event.target.classList.add('bg-blue-500', 'text-white');

            let filteredTransactions = allTransactions;
            if (type !== 'all') {
                filteredTransactions = allTransactions.filter(t => t.type === type);
            }
            
            displayTransactions(filteredTransactions);
        };

        // Calculate growth
        window.calculateGrowth = function() {
            const amount = parseFloat(document.getElementById('growthAmount').value);
            const months = parseInt(document.getElementById('growthMonths').value);
            
            if (!amount || !months || amount <= 0 || months <= 0) {
                document.getElementById('growthResult').innerHTML = '<p class="text-red-500">Please enter valid amount and months.</p>';
                return;
            }
            
            const finalAmount = amount * Math.pow(1.3, months);
            const totalGrowth = finalAmount - amount;
            const monthlyGrowth = amount * 0.3;
            
            document.getElementById('growthResult').innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <h4 class="font-semibold text-green-800 mb-2">Growth Projection</h4>
                    <div class="space-y-2 text-sm">
                        <p><span class="font-medium">Initial Amount:</span> $${amount.toFixed(2)}</p>
                        <p><span class="font-medium">Monthly Growth:</span> $${monthlyGrowth.toFixed(2)} (30%)</p>
                        <p><span class="font-medium">Total Growth:</span> $${totalGrowth.toFixed(2)}</p>
                        <p class="text-lg font-bold text-green-600">Final Amount: $${finalAmount.toFixed(2)}</p>
                    </div>
                </div>
            `;
        };

        // Logout function
        window.logout = function() {
            signOut(auth).then(() => {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('isAdmin');
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error('Error signing out:', error);
            });
        };
    </script>
</head>
<body>
    <div class="min-h-screen bg-gray-50">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <div class="w-10 h-10 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full flex items-center justify-center">
                            <span class="text-white font-bold">K</span>
                        </div>
                        <h1 class="text-2xl font-bold text-gray-800">Mavro Ledger</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-gray-600">Welcome, <span id="userName" class="font-semibold"></span></span>
                        <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="flex">
            <!-- Sidebar -->
            <nav class="w-64 bg-white shadow-sm h-screen sticky top-0">
                <div class="p-6">
                    <ul class="space-y-2">
                        <li>
                            <a href="dashboard.html" class="w-full text-left px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 transition-colors flex items-center">
                                üìä Dashboard
                            </a>
                        </li>
                        <li>
                            <a href="my-page.html" class="w-full text-left px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 transition-colors flex items-center">
                                üë§ My Page
                            </a>
                        </li>
                        <li>
                            <a href="mavro.html" class="w-full text-left px-4 py-3 rounded-lg bg-blue-50 text-blue-600 font-medium flex items-center">
                                üí∞ Mavro
                            </a>
                        </li>
                        <li>
                            <a href="referrals.html" class="w-full text-left px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 transition-colors flex items-center">
                                üë• Referrals
                            </a>
                        </li>
                        <li>
                            <a href="support.html" class="w-full text-left px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 transition-colors flex items-center">
                                üéß Support
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="flex-1 p-6">
                <!-- Mavro Summary -->
                <div class="grid md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-6 rounded-2xl">
                        <h3 class="text-lg font-semibold mb-2">Current Balance</h3>
                        <p class="text-3xl font-bold" id="currentBalance">$0.00</p>
                        <p class="text-green-100 text-sm mt-2">Available Mavro</p>
                    </div>
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-2xl">
                        <h3 class="text-lg font-semibold mb-2">Total Growth</h3>
                        <p class="text-3xl font-bold" id="totalGrowth">$0.00</p>
                        <p class="text-blue-100 text-sm mt-2">Lifetime Earnings</p>
                    </div>
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6 rounded-2xl">
                        <h3 class="text-lg font-semibold mb-2">Monthly Rate</h3>
                        <p class="text-3xl font-bold" id="monthlyRate">30%</p>
                        <p class="text-purple-100 text-sm mt-2">Guaranteed Growth</p>
                    </div>
                    <div class="bg-gradient-to-r from-yellow-500 to-orange-500 text-white p-6 rounded-2xl">
                        <h3 class="text-lg font-semibold mb-2">Months Active</h3>
                        <p class="text-3xl font-bold" id="monthsActive">0</p>
                        <p class="text-yellow-100 text-sm mt-2">Since Joining</p>
                    </div>
                </div>

                <!-- Growth Calculator -->
                <div class="bg-white rounded-2xl shadow-sm p-6 mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">Growth Calculator</h3>
                    <div class="grid md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Amount ($)</label>
                            <input type="number" id="growthAmount" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter amount">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Months</label>
                            <input type="number" id="growthMonths" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Number of months">
                        </div>
                        <div class="flex items-end">
                            <button onclick="calculateGrowth()" class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition-colors">
                                Calculate Growth
                            </button>
                        </div>
                    </div>
                    <div id="growthResult" class="mt-6">
                        <!-- Growth results will appear here -->
                    </div>
                </div>

                <!-- Transaction History -->
                <div class="bg-white rounded-2xl shadow-sm p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Transaction History</h3>
                        <div class="flex space-x-2">
                            <button onclick="filterTransactions('all')" class="filter-btn px-4 py-2 rounded-lg bg-blue-500 text-white text-sm">All</button>
                            <button onclick="filterTransactions('bonus')" class="filter-btn px-4 py-2 rounded-lg bg-gray-200 text-gray-700 text-sm">Bonus</button>
                            <button onclick="filterTransactions('provide')" class="filter-btn px-4 py-2 rounded-lg bg-gray-200 text-gray-700 text-sm">Provide Help</button>
                            <button onclick="filterTransactions('get')" class="filter-btn px-4 py-2 rounded-lg bg-gray-200 text-gray-700 text-sm">Get Help</button>
                            <button onclick="filterTransactions('growth')" class="filter-btn px-4 py-2 rounded-lg bg-gray-200 text-gray-700 text-sm">Growth</button>
                        </div>
                    </div>
                    <div id="transactionsList" class="space-y-4">
                        <!-- Transactions will be loaded here -->
                    </div>
                </div>
            </main>
        </div>
    </div>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'974a63bc14c194bb',t:'MTc1NjExNzU3MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
