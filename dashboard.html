<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Koinonia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc, updateDoc, serverTimestamp, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC9ikNYt8QnD6FHm1MOq11HB0kTP_X8qNQ",
            authDomain: "wealth-club-65dab.firebaseapp.com",
            projectId: "wealth-club-65dab",
            storageBucket: "wealth-club-65dab.firebasestorage.app",
            messagingSenderId: "906138407714",
            appId: "1:906138407714:web:78e002acd44d2af326cb7b",
            measurementId: "G-8H8CZ65956"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            const userData = localStorage.getItem('currentUser');
            if (!userData) {
                window.location.href = 'login.html';
                return;
            }

            currentUser = JSON.parse(userData);
            document.getElementById('userName').textContent = currentUser.name;
            loadDashboardData();
        });

        // Load dashboard data
        async function loadDashboardData() {
            if (!currentUser) return;

            try {
                const userDocRef = doc(db, 'users', currentUser.uid);
                const userDoc = await getDoc(userDocRef);
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    // Update the local currentUser object with fresh data
                    currentUser = { uid: currentUser.uid, ...userData };
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    document.getElementById('totalMavro').textContent = `$${(userData.mavroBalance || 0).toFixed(2)}`;
                    document.getElementById('accountStatus').textContent = userData.status || 'Active';
                }

                loadRecentActivity();
                loadTransactionQueue();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // Load recent activity from mavroTransactions
        async function loadRecentActivity() {
            const q = query(collection(db, 'mavroTransactions'), where('userId', '==', currentUser.uid));
            const querySnapshot = await getDocs(q);
            const activityContainer = document.getElementById('recentActivity');
            activityContainer.innerHTML = ''; // Clear previous entries

            if (querySnapshot.empty) {
                activityContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No recent activity.</p>';
                return;
            }

            querySnapshot.forEach((doc) => {
                const transaction = doc.data();
                const activityItem = createActivityItem(transaction);
                activityContainer.appendChild(activityItem);
            });
        }

        // Create a visual element for an activity item
        function createActivityItem(transaction) {
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-4 p-4 hover:bg-gray-50 rounded-lg transition-colors';
            
            const typeDetails = {
                bonus: { color: 'green', icon: 'üéÅ', sign: '+' },
                provide: { color: 'blue', icon: 'ü§ù', sign: '+' },
                get: { color: 'red', icon: 'üôè', sign: '-' },
                growth: { color: 'purple', icon: 'üìà', sign: '+' }
            };
            const details = typeDetails[transaction.type] || { color: 'gray', icon: 'üí∞', sign: '' };
            const amount = Math.abs(transaction.amount);

            div.innerHTML = `
                <div class="w-10 h-10 bg-${details.color}-100 rounded-full flex items-center justify-center">
                    <span class="text-xl">${details.icon}</span>
                </div>
                <div class="flex-1">
                    <p class="font-semibold text-gray-800">${transaction.description}</p>
                    <p class="text-gray-600 text-sm">${transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)} (${transaction.status})</p>
                </div>
                <div class="text-right">
                    <p class="font-bold text-${details.color}-600">${details.sign}$${amount.toFixed(2)}</p>
                    <p class="text-gray-500 text-sm">${new Date(transaction.date).toLocaleDateString()}</p>
                </div>
            `;
            return div;
        }

        // Load pending help requests into the transaction queue
        async function loadTransactionQueue() {
            const q = query(collection(db, 'helpRequests'), where('userId', '==', currentUser.uid), where('status', '==', 'pending'));
            const querySnapshot = await getDocs(q);
            const queueContainer = document.getElementById('transactionQueue');
            queueContainer.innerHTML = ''; // Clear demo data

            if (querySnapshot.empty) {
                queueContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No pending transactions in your queue.</p>';
                return;
            }

            querySnapshot.forEach((doc) => {
                const request = doc.data();
                const queueItem = createQueueItem(request);
                queueContainer.appendChild(queueItem);
            });
        }

        // Create a visual element for a queue item
        function createQueueItem(request) {
            const div = document.createElement('div');
            const isProvide = request.type === 'provide';
            const color = isProvide ? 'yellow' : 'green';
            const title = isProvide ? 'Provide Help Order' : 'Get Help Request';
            const description = isProvide ? 'Waiting to be matched with a recipient.' : 'Waiting to be matched with a provider.';

            div.className = `flex items-center justify-between p-4 bg-${color}-50 rounded-lg border-l-4 border-${color}-400`;
            div.innerHTML = `
                <div>
                    <p class="font-semibold text-gray-800">${title}</p>
                    <p class="text-gray-600">${description}</p>
                    <p class="text-sm text-gray-500">Amount: $${request.amount.toFixed(2)} ‚Ä¢ Status: ${request.status}</p>
                </div>
                <button class="bg-${color}-500 text-white px-4 py-2 rounded-lg hover:bg-${color}-600 transition-colors">
                    View Details
                </button>
            `;
            return div;
        }

        // Provide Help function (Now creates a 'frozen' Mavro transaction)
        window.provideHelp = async function() {
            const amountInput = prompt('How much would you like to provide? (Minimum $100)');
            if (!amountInput) return;

            const amount = parseFloat(amountInput);
            if (isNaN(amount) || amount < 100) {
                alert('Invalid amount. Minimum is $100.');
                return;
            }

            try {
                const now = new Date();
                const releaseDate = new Date(now.setDate(now.getDate() + 30));

                // 1. Create the 'Provide Help' request
                await addDoc(collection(db, 'helpRequests'), {
                    userId: currentUser.uid,
                    userName: currentUser.name,
                    type: 'provide',
                    amount: amount,
                    status: 'pending', // Will be updated to 'matched' by admin
                    createdAt: new Date().toISOString()
                });

                // 2. Create the corresponding 'frozen' Mavro transaction
                await addDoc(collection(db, 'mavroTransactions'), {
                    userId: currentUser.uid,
                    userName: currentUser.name,
                    type: 'provide',
                    description: `Provided help of $${amount}`,
                    amount: amount,
                    status: 'frozen', // This is key. It's not available for withdrawal yet.
                    date: new Date().toISOString(),
                    growthReleaseDate: releaseDate.toISOString()
                });

                alert(`Your offer to provide $${amount} has been recorded. It will mature in 30 days.`);
                loadDashboardData();
            } catch (error) {
                alert('Error creating request: ' + error.message);
            }
        };
        
        // Get Help function (Now checks for available/matured balance)
        window.getHelp = async function() {
            try {
                // 1. Calculate the user's actual withdrawable balance from matured Mavro
                const mavroQuery = query(collection(db, 'mavroTransactions'), where('userId', '==', currentUser.uid));
                const mavroSnapshot = await getDocs(mavroQuery);
                let withdrawableBalance = 0;
                const now = new Date();

                mavroSnapshot.forEach(doc => {
                    const t = doc.data();
                    const releaseDate = new Date(t.growthReleaseDate || 0);
                    // Money is withdrawable if it's a bonus OR if it's a 'provide' that has matured
                    if ( (t.type === 'provide' && t.status !== 'frozen') || (t.type === 'bonus') || (t.type === 'growth') ) {
                       withdrawableBalance += t.amount;
                    } else if (t.type === 'get') {
                        withdrawableBalance -= t.amount; // Subtract previous withdrawals
                    }
                });
                
                if (withdrawableBalance <= 0) {
                    alert("You have no matured funds available for withdrawal.");
                    return;
                }

                const amountInput = prompt(`How much help do you need?\nYour maximum available balance is $${withdrawableBalance.toFixed(2)}.`);
                if (!amountInput) return;
                
                const amount = parseFloat(amountInput);
                if (isNaN(amount) || amount <= 0 || amount > withdrawableBalance) {
                    alert('Invalid amount. Please enter a value up to your available balance.');
                    return;
                }

                // 2. Create the 'Get Help' request
                await addDoc(collection(db, 'helpRequests'), {
                    userId: currentUser.uid,
                    userName: currentUser.name,
                    type: 'get',
                    amount: amount,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                });

                // 3. Create a debit transaction and update the main balance
                await addDoc(collection(db, 'mavroTransactions'), {
                    userId: currentUser.uid,
                    userName: currentUser.name,
                    type: 'get',
                    description: `Requested help of $${amount}`,
                    amount: -amount, // Negative amount for withdrawal
                    status: 'completed',
                    date: new Date().toISOString()
                });
                
                // 4. Update the user's main mavroBalance
                const newBalance = currentUser.mavroBalance - amount;
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    mavroBalance: newBalance
                });

                alert(`Your request for $${amount} has been submitted successfully.`);
                loadDashboardData();

            } catch (error) {
                alert('Error creating get help request: ' + error.message);
            }
        };

        // Logout function
        window.logout = function() {
            signOut(auth).then(() => {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('isAdmin');
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error('Error signing out:', error);
            });
        };
    </script>
</head>
<body>
    <div class="min-h-screen bg-gray-50">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <div class="w-10 h-10 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full flex items-center justify-center">
                            <span class="text-white font-bold">K</span>
                        </div>
                        <h1 class="text-2xl font-bold text-gray-800">Koinonia Dashboard</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-gray-600">Welcome, <span id="userName" class="font-semibold"></span></span>
                        <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="flex">
            <!-- Sidebar -->
            <nav class="w-64 bg-white shadow-sm h-screen sticky top-0">
                <div class="p-6">
                    <ul class="space-y-2">
                        <li>
                            <a href="dashboard.html" class="w-full text-left px-4 py-3 rounded-lg bg-blue-50 text-blue-600 font-medium flex items-center">
                                üìä Dashboard
                            </a>
                        </li>
                        <li>
                            <a href="my-page.html" class="w-full text-left px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 transition-colors flex items-center">
                                üë§ My Page
                            </a>
                        </li>
                        <li>
                            <a href="mavro.html" class="w-full text-left px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 transition-colors flex items-center">
                                üí∞ Mavro
                            </a>
                        </li>
                        <li>
                            <a href="referrals.html" class="w-full text-left px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 transition-colors flex items-center">
                                üë• Referrals
                            </a>
                        </li>
                        <li>
                            <a href="support.html" class="w-full text-left px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 transition-colors flex items-center">
                                üéß Support
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="flex-1 p-6">
                <!-- Primary Action Buttons -->
                <div class="grid md:grid-cols-2 gap-6 mb-8">
                    <button onclick="provideHelp()" class="bg-gradient-to-r from-green-500 to-green-600 text-white p-8 rounded-2xl hover:from-green-600 hover:to-green-700 transition-all transform hover:scale-105 shadow-lg">
                        <div class="text-center">
                            <div class="text-4xl mb-4">ü§ù</div>
                            <h3 class="text-2xl font-bold mb-2">Provide Help</h3>
                            <p class="text-green-100">Help other community members and grow your Mavro by 30% monthly</p>
                        </div>
                    </button>
                    <button onclick="getHelp()" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-8 rounded-2xl hover:from-blue-600 hover:to-blue-700 transition-all transform hover:scale-105 shadow-lg">
                        <div class="text-center">
                            <div class="text-4xl mb-4">üôè</div>
                            <h3 class="text-2xl font-bold mb-2">Get Help</h3>
                            <p class="text-blue-100">Request assistance from the community when you need it</p>
                        </div>
                    </button>
                </div>

                <!-- Account Summary -->
                <div class="bg-white rounded-2xl shadow-sm p-6 mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">Account Summary</h3>
                    <div class="grid md:grid-cols-3 gap-6">
                        <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-6 rounded-xl">
                            <h4 class="text-lg font-semibold mb-2">Total Mavro</h4>
                            <p class="text-3xl font-bold" id="totalMavro">$0.00</p>
                            <p class="text-yellow-100 text-sm mt-2">Overall Balance</p>
                        </div>
                        <div class="bg-gradient-to-r from-green-400 to-green-500 text-white p-6 rounded-xl">
                            <h4 class="text-lg font-semibold mb-2">Monthly Growth</h4>
                            <p class="text-3xl font-bold">30%</p>
                            <p class="text-green-100 text-sm mt-2">On Matured Mavro</p>
                        </div>
                        <div class="bg-gradient-to-r from-purple-400 to-purple-500 text-white p-6 rounded-xl">
                            <h4 class="text-lg font-semibold mb-2">Status</h4>
                            <p class="text-2xl font-bold" id="accountStatus">Active</p>
                            <p class="text-purple-100 text-sm mt-2">Account Standing</p>
                        </div>
                    </div>
                </div>

                <!-- Transaction Queue -->
                <div class="bg-white rounded-2xl shadow-sm p-6 mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">Transaction Queue</h3>
                    <!-- REMOVED DEMO DATA - This will now be populated by JavaScript -->
                    <div id="transactionQueue" class="space-y-4">
                        <!-- Dynamic queue items will be loaded here -->
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white rounded-2xl shadow-sm p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">Recent Activity</h3>
                    <div id="recentActivity" class="space-y-4">
                        <!-- Dynamic activity items will be loaded here -->
                    </div>
                </div>
            </main>
        </div>
    </div>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'974a5f57d4f494bb',t:'MTc1NjExNzM5MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
