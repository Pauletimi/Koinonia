<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Koinonia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc, updateDoc, serverTimestamp, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC9ikNYt8QnD6FHm1MOq11HB0kTP_X8qNQ",
            authDomain: "wealth-club-65dab.firebaseapp.com",
            projectId: "wealth-club-65dab",
            storageBucket: "wealth-club-65dab.firebasestorage.app",
            messagingSenderId: "906138407714",
            appId: "1:906138407714:web:78e002acd44d2af326cb7b",
            measurementId: "G-8H8CZ65956"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            const userData = localStorage.getItem('currentUser');
            if (!userData) {
                window.location.href = 'login.html';
                return;
            }

            currentUser = JSON.parse(userData);
            document.getElementById('userName').textContent = currentUser.name;
            loadDashboardData();
        });

        // Load dashboard data
        async function loadDashboardData() {
            if (!currentUser) return;

            try {
                const userDocRef = doc(db, 'users', currentUser.uid);
                const userDoc = await getDoc(userDocRef);
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    // Update the local currentUser object with fresh data
                    currentUser = { uid: currentUser.uid, ...userData };
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    document.getElementById('totalMavro').textContent = `$${(userData.mavroBalance || 0).toFixed(2)}`;
                    document.getElementById('accountStatus').textContent = userData.status || 'Active';
                }

                loadRecentActivity();
                loadTransactionQueue(); // This will now show requests and matches
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // Load recent activity from mavroTransactions
        async function loadRecentActivity() {
            const q = query(collection(db, 'mavroTransactions'), where('userId', '==', currentUser.uid));
            const querySnapshot = await getDocs(q);
            const activityContainer = document.getElementById('recentActivity');
            activityContainer.innerHTML = ''; // Clear previous entries

            if (querySnapshot.empty) {
                activityContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No recent activity.</p>';
                return;
            }

            querySnapshot.forEach((doc) => {
                const transaction = doc.data();
                const activityItem = createActivityItem(transaction);
                activityContainer.appendChild(activityItem);
            });
        }

        // Create a visual element for an activity item
        function createActivityItem(transaction) {
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-4 p-4 hover:bg-gray-50 rounded-lg transition-colors';
            
            const isCredit = transaction.amount > 0;
            const typeDetails = {
                bonus: { color: 'green', icon: 'üéÅ'},
                provide: { color: 'blue', icon: 'ü§ù'},
                get: { color: 'red', icon: 'üôè'},
                growth: { color: 'purple', icon: 'üìà'}
            };
            const details = typeDetails[transaction.type] || { color: 'gray', icon: 'üí∞'};

            div.innerHTML = `
                <div class="w-10 h-10 bg-${details.color}-100 rounded-full flex items-center justify-center">
                    <span class="text-xl">${details.icon}</span>
                </div>
                <div class="flex-1">
                    <p class="font-semibold text-gray-800">${transaction.description}</p>
                    <p class="text-gray-600 text-sm">${transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)}</p>
                </div>
                <div class="text-right">
                    <p class="font-bold text-${isCredit ? 'green' : 'red'}-600">${isCredit ? '+' : '-'}$${Math.abs(transaction.amount).toFixed(2)}</p>
                    <p class="text-gray-500 text-sm">${new Date(transaction.date).toLocaleDateString()}</p>
                </div>
            `;
            return div;
        }

        // --- CORRECTED: Load all relevant requests and matches for the user ---
        async function loadTransactionQueue() {
            const queueContainer = document.getElementById('transactionQueue');
            queueContainer.innerHTML = ''; // Clear existing items

            // 1. Get user's 'helpRequests' that are still pending or matched
            const requestsQuery = query(collection(db, 'helpRequests'), where('userId', '==', currentUser.uid), where('status', 'in', ['pending', 'matched']));
            const requestsSnapshot = await getDocs(requestsQuery);
            requestsSnapshot.forEach(doc => {
                queueContainer.appendChild(createQueueItem(doc.data()));
            });

            // 2. Get user's 'matches' where they are either the provider or getter
            const matchesProviderQuery = query(collection(db, 'matches'), where('providerId', '==', currentUser.uid), where('status', '==', 'pending_payment'));
            const matchesProviderSnapshot = await getDocs(matchesProviderQuery);
            matchesProviderSnapshot.forEach(doc => {
                queueContainer.appendChild(createMatchItem(doc.data()));
            });

            const matchesGetterQuery = query(collection(db, 'matches'), where('getterId', '==', currentUser.uid), where('status', '==', 'pending_payment'));
            const matchesGetterSnapshot = await getDocs(matchesGetterQuery);
            matchesGetterSnapshot.forEach(doc => {
                queueContainer.appendChild(createMatchItem(doc.data()));
            });

            if (queueContainer.innerHTML === '') {
                 queueContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No active orders in your queue.</p>';
            }
        }

        // --- CORRECTED: Function to display a pending help request ---
        function createQueueItem(request) {
            const div = document.createElement('div');
            const isProvide = request.type === 'provide';
            const color = isProvide ? 'yellow' : 'green';
            const title = isProvide ? 'Provide Help Request' : 'Get Help Request';
            const description = `Your request is currently ${request.status} and waiting for admin action.`;

            div.className = `flex items-center justify-between p-4 bg-${color}-50 rounded-lg border-l-4 border-${color}-400`;
            div.innerHTML = `
                <div>
                    <p class="font-semibold text-gray-800">${title}</p>
                    <p class="text-gray-600">${description}</p>
                    <p class="text-sm text-gray-500">Amount: $${request.amount.toFixed(2)}</p>
                </div>
                <button class="bg-gray-500 text-white px-4 py-2 rounded-lg cursor-not-allowed">
                    Pending
                </button>
            `;
            return div;
        }
        
        // --- NEW: Function to display an active match ---
        function createMatchItem(match) {
            const div = document.createElement('div');
            const isProvider = match.providerId === currentUser.uid;
            const color = isProvider ? 'blue' : 'purple';
            const title = isProvider ? `You have been matched to help ${match.getterName}` : `You have been matched to receive help from ${match.providerName}`;
            const description = `Please follow instructions to complete the payment.`;

            div.className = `flex items-center justify-between p-4 bg-${color}-50 rounded-lg border-l-4 border-${color}-400`;
            div.innerHTML = `
                <div>
                    <p class="font-semibold text-gray-800">${title}</p>
                    <p class="text-gray-600">${description}</p>
                    <p class="text-sm text-gray-500">Amount: $${match.amount.toFixed(2)}</p>
                </div>
                <button class="bg-${color}-500 text-white px-4 py-2 rounded-lg hover:bg-${color}-600">
                    View Details & Confirm
                </button>
            `;
            return div;
        }

        // --- CORRECTED: Provide Help function - simplified to only create a request ---
        window.provideHelp = async function() {
            const amountInput = prompt('How much would you like to provide? (Minimum $100)');
            if (!amountInput) return;

            const amount = parseFloat(amountInput);
            if (isNaN(amount) || amount < 100) {
                alert('Invalid amount. Minimum is $100.');
                return;
            }

            try {
                await addDoc(collection(db, 'helpRequests'), {
                    userId: currentUser.uid,
                    userName: currentUser.name,
                    type: 'provide',
                    amount: amount,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                });

                alert(`Your request to provide $${amount} has been submitted. It is now pending admin matching.`);
                loadDashboardData();
            } catch (error) {
                alert('Error creating request: ' + error.message);
            }
        };
        
        // --- CORRECTED: Get Help function - simplified to only create a request ---
        window.getHelp = async function() {
            // Admin will now be responsible for verifying the user's balance
            const amountInput = prompt(`How much help would you like to request?\n(Admin will verify your available Mavro balance before matching).`);
            if (!amountInput) return;
            
            const amount = parseFloat(amountInput);
            if (isNaN(amount) || amount <= 0) {
                alert('Please enter a valid amount.');
                return;
            }
            
            try {
                await addDoc(collection(db, 'helpRequests'), {
                    userId: currentUser.uid,
                    userName: currentUser.name,
                    type: 'get',
                    amount: amount,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                });

                alert(`Your request for $${amount} has been submitted. It is now pending admin matching.`);
                loadDashboardData();

            } catch (error) {
                alert('Error creating request: ' + error.message);
            }
        };

        // Logout function
        window.logout = function() {
            signOut(auth).then(() => {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('isAdmin');
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error('Error signing out:', error);
            });
        };
    </script>
</head>
<body>
    <div class="min-h-screen bg-gray-50">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <div class="w-10 h-10 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full flex items-center justify-center">
                            <span class="text-white font-bold">K</span>
                        </div>
                        <h1 class="text-2xl font-bold text-gray-800">Koinonia Dashboard</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-gray-600">Welcome, <span id="userName" class="font-semibold"></span></span>
                        <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="flex">
            <!-- Sidebar -->
            <nav class="w-64 bg-white shadow-sm h-screen sticky top-0">
                <div class="p-6">
                    <ul class="space-y-2">
                        <li>
                            <a href="dashboard.html" class="w-full text-left px-4 py-3 rounded-lg bg-blue-50 text-blue-600 font-medium flex items-center">
                                üìä Dashboard
                            </a>
                        </li>
                        <li>
                            <a href="my-page.html" class="w-full text-left px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 transition-colors flex items-center">
                                üë§ My Page
                            </a>
                        </li>
                        <li>
                            <a href="mavro.html" class="w-full text-left px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 transition-colors flex items-center">
                                üí∞ Mavro
                            </a>
                        </li>
                        <li>
                            <a href="referrals.html" class="w-full text-left px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 transition-colors flex items-center">
                                üë• Referrals
                            </a>
                        </li>
                        <li>
                            <a href="support.html" class="w-full text-left px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 transition-colors flex items-center">
                                üéß Support
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="flex-1 p-6">
                <!-- Primary Action Buttons -->
                <div class="grid md:grid-cols-2 gap-6 mb-8">
                    <button onclick="provideHelp()" class="bg-gradient-to-r from-green-500 to-green-600 text-white p-8 rounded-2xl hover:from-green-600 hover:to-green-700 transition-all transform hover:scale-105 shadow-lg">
                        <div class="text-center">
                            <div class="text-4xl mb-4">ü§ù</div>
                            <h3 class="text-2xl font-bold mb-2">Provide Help</h3>
                            <p class="text-green-100">Request to provide help and be matched by an admin.</p>
                        </div>
                    </button>
                    <button onclick="getHelp()" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-8 rounded-2xl hover:from-blue-600 hover:to-blue-700 transition-all transform hover:scale-105 shadow-lg">
                        <div class="text-center">
                            <div class="text-4xl mb-4">üôè</div>
                            <h3 class="text-2xl font-bold mb-2">Get Help</h3>
                            <p class="text-blue-100">Request to get help and be matched by an admin.</p>
                        </div>
                    </button>
                </div>

                <!-- Account Summary -->
                <div class="bg-white rounded-2xl shadow-sm p-6 mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">Account Summary</h3>
                    <div class="grid md:grid-cols-3 gap-6">
                        <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-6 rounded-xl">
                            <h4 class="text-lg font-semibold mb-2">Total Mavro</h4>
                            <p class="text-3xl font-bold" id="totalMavro">$0.00</p>
                            <p class="text-yellow-100 text-sm mt-2">Overall Balance</p>
                        </div>
                        <div class="bg-gradient-to-r from-green-400 to-green-500 text-white p-6 rounded-xl">
                            <h4 class="text-lg font-semibold mb-2">Monthly Growth</h4>
                            <p class="text-3xl font-bold">30%</p>
                            <p class="text-green-100 text-sm mt-2">On Matured Mavro</p>
                        </div>
                        <div class="bg-gradient-to-r from-purple-400 to-purple-500 text-white p-6 rounded-xl">
                            <h4 class="text-lg font-semibold mb-2">Status</h4>
                            <p class="text-2xl font-bold" id="accountStatus">Active</p>
                            <p class="text-purple-100 text-sm mt-2">Account Standing</p>
                        </div>
                    </div>
                </div>

                <!-- Transaction Queue -->
                <div class="bg-white rounded-2xl shadow-sm p-6 mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">Active Orders & Requests</h3>
                    <div id="transactionQueue" class="space-y-4">
                        <!-- Dynamic queue items will be loaded here -->
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white rounded-2xl shadow-sm p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">Recent Activity</h3>
                    <div id="recentActivity" class="space-y-4">
                        <!-- Dynamic activity items will be loaded here -->
                    </div>
                </div>
            </main>
        </div>
    </div>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'974a5f57d4f494bb',t:'MTc1NjExNzM5MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
