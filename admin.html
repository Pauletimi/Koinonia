<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Koinonia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        // --- ADDED addDoc to imports for matching ---
        import { getFirestore, collection, getDocs, doc, setDoc, addDoc, updateDoc, deleteDoc, query, where, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC9ikNYt8QnD6FHm1MOq11HB0kTP_X8qNQ",
            authDomain: "wealth-club-65dab.firebaseapp.com",
            projectId: "wealth-club-65dab",
            storageBucket: "wealth-club-65dab.firebasestorage.app",
            messagingSenderId: "906138407714",
            appId: "1:906138407714:web:78e002acd44d2af326cb7b",
            measurementId: "G-8H8CZ65956"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentAdmin = null;
        let allUsers = [];
        let allTransactions = [];
        let allTickets = [];
        // --- NEW: Variables for the matching system ---
        let pendingProviders = [];
        let pendingGetters = [];
        let selectedProvider = null;
        let selectedGetter = null;

        // Check admin authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            const userData = localStorage.getItem('currentUser');
            const isAdmin = localStorage.getItem('isAdmin');
            
            if (!userData || !isAdmin || isAdmin !== 'true') {
                window.location.href = 'login.html';
                return;
            }

            currentAdmin = JSON.parse(userData);
            document.getElementById('adminName').textContent = currentAdmin.name;
            
            loadDashboardData();
            loadUsers();
            loadTransactions();
            loadSupportTickets();
            initializeCharts();
            loadSystemSettings();
            // --- NEW: Load pending requests for matching ---
            loadHelpRequests();
        });

        // --- ALL EXISTING JAVASCRIPT FUNCTIONS ARE PRESERVED HERE ---
        // (For brevity, only new functions are shown in detail, but none are removed)

        // Load dashboard data
        async function loadDashboardData() { /* ... existing code ... */ }
        // Load users
        async function loadUsers() { /* ... existing code ... */ }
        // Display users
        function displayUsers(users) { /* ... existing code ... */ }
        // Create user element
        function createUserElement(user) { /* ... existing code ... */ }
        // Load transactions
        async function loadTransactions() { /* ... existing code ... */ }
        // Display transactions
        function displayTransactions(transactions) { /* ... existing code ... */ }
        // Create transaction element
        function createTransactionElement(transaction) { /* ... existing code ... */ }
        // Load support tickets
        async function loadSupportTickets() { /* ... existing code ... */ }
        // Display support tickets
        function displaySupportTickets(tickets) { /* ... existing code ... */ }
        // Create ticket element
        function createTicketElement(ticket) { /* ... existing code ... */ }
        // Initialize charts
        function initializeCharts() { /* ... existing code ... */ }

        // --- NEW: Functions for the Manual Matching System ---

        // Load all pending 'provide' and 'get' help requests
        async function loadHelpRequests() {
            const requestsQuery = query(collection(db, 'helpRequests'), where('status', '==', 'pending'));
            const snapshot = await getDocs(requestsQuery);

            pendingProviders = [];
            pendingGetters = [];

            snapshot.forEach(doc => {
                const request = { id: doc.id, ...doc.data() };
                if (request.type === 'provide') {
                    pendingProviders.push(request);
                } else if (request.type === 'get') {
                    pendingGetters.push(request);
                }
            });

            displayHelpRequests();
        }

        // Display the lists of providers and getters
        function displayHelpRequests() {
            const providersContainer = document.getElementById('providersList');
            const gettersContainer = document.getElementById('gettersList');
            providersContainer.innerHTML = '';
            gettersContainer.innerHTML = '';

            pendingProviders.forEach(req => {
                const reqElement = document.createElement('div');
                reqElement.id = `provider-${req.id}`;
                reqElement.className = 'border border-gray-200 p-3 rounded-lg cursor-pointer';
                reqElement.innerHTML = `
                    <p class="font-semibold">${req.userName}</p>
                    <p class="text-green-600 font-bold">$${req.amount.toFixed(2)}</p>
                `;
                reqElement.onclick = () => selectProvider(req.id);
                providersContainer.appendChild(reqElement);
            });

            pendingGetters.forEach(req => {
                const reqElement = document.createElement('div');
                reqElement.id = `getter-${req.id}`;
                reqElement.className = 'border border-gray-200 p-3 rounded-lg cursor-pointer';
                reqElement.innerHTML = `
                    <p class="font-semibold">${req.userName}</p>
                    <p class="text-blue-600 font-bold">$${req.amount.toFixed(2)}</p>
                `;
                reqElement.onclick = () => selectGetter(req.id);
                gettersContainer.appendChild(reqElement);
            });
        }

        // Handle selection of a provider
        window.selectProvider = function(reqId) {
            selectedProvider = pendingProviders.find(p => p.id === reqId);
            document.getElementById('selectedProviderInfo').innerHTML = `
                <p><strong>Provider:</strong> ${selectedProvider.userName}</p>
                <p><strong>Amount:</strong> <span class="text-green-600">$${selectedProvider.amount.toFixed(2)}</span></p>
            `;
            document.querySelectorAll('#providersList > div').forEach(div => div.classList.remove('ring-2', 'ring-green-500'));
            document.getElementById(`provider-${reqId}`).classList.add('ring-2', 'ring-green-500');
            checkMatchability();
        };

        // Handle selection of a getter
        window.selectGetter = function(reqId) {
            selectedGetter = pendingGetters.find(g => g.id === reqId);
            document.getElementById('selectedGetterInfo').innerHTML = `
                <p><strong>Recipient:</strong> ${selectedGetter.userName}</p>
                <p><strong>Amount:</strong> <span class="text-blue-600">$${selectedGetter.amount.toFixed(2)}</span></p>
            `;
            document.querySelectorAll('#gettersList > div').forEach(div => div.classList.remove('ring-2', 'ring-blue-500'));
            document.getElementById(`getter-${reqId}`).classList.add('ring-2', 'ring-blue-500');
            checkMatchability();
        };
        
        // Enable the match button only if selections are valid
        function checkMatchability() {
            const matchButton = document.getElementById('matchButton');
            if (selectedProvider && selectedGetter) {
                matchButton.disabled = false;
                matchButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                matchButton.classList.add('bg-purple-600', 'hover:bg-purple-700');
            } else {
                matchButton.disabled = true;
                matchButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                matchButton.classList.remove('bg-purple-600', 'hover:bg-purple-700');
            }
        }

        // Finalize the match
        window.createMatch = async function() {
            if (!selectedProvider || !selectedGetter) {
                alert("Please select both a provider and a recipient.");
                return;
            }
            if (selectedProvider.amount < selectedGetter.amount) {
                alert("Provider's amount is less than the recipient's requested amount.");
                return;
            }
            if (!confirm(`Match ${selectedProvider.userName} ($${selectedProvider.amount}) with ${selectedGetter.userName} ($${selectedGetter.amount})?`)) {
                return;
            }

            try {
                await addDoc(collection(db, 'matches'), {
                    providerId: selectedProvider.userId,
                    providerName: selectedProvider.userName,
                    providerRequestId: selectedProvider.id,
                    getterId: selectedGetter.userId,
                    getterName: selectedGetter.userName,
                    getterRequestId: selectedGetter.id,
                    amount: selectedGetter.amount,
                    status: 'pending_payment',
                    createdAt: new Date().toISOString()
                });

                await updateDoc(doc(db, 'helpRequests', selectedProvider.id), { status: 'matched' });
                await updateDoc(doc(db, 'helpRequests', selectedGetter.id), { status: 'matched' });
                
                alert("Match created successfully!");

                selectedProvider = null;
                selectedGetter = null;
                document.getElementById('selectedProviderInfo').innerHTML = '';
                document.getElementById('selectedGetterInfo').innerHTML = '';
                checkMatchability();
                loadHelpRequests();
            } catch (error) {
                console.error("Error creating match: ", error);
                alert("Failed to create match: " + error.message);
            }
        };
        
        // Load system settings
        async function loadSystemSettings() { /* ... existing code ... */ }
        // Save system settings
        window.saveSystemSettings = async function() { /* ... existing code ... */ };
        // Admin functions
        window.editUser = function(userId) { /* ... existing code ... */ };
        window.suspendUser = async function(userId) { /* ... existing code ... */ };
        async function updateUserBalance(userId, newBalance) { /* ... existing code ... */ }
        window.resolveTicket = async function(ticketId) { /* ... existing code ... */ };
        // Tab switching
        window.showTab = function(tabName) { /* ... existing code ... */ };
        // Search users
        window.searchUsers = function() { /* ... existing code ... */ };
        // Logout function
        window.logout = function() { /* ... existing code ... */ };

    </script>
</head>
<body>
    <div class="min-h-screen bg-gray-50">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <div class="w-10 h-10 bg-gradient-to-r from-red-500 to-red-600 rounded-full flex items-center justify-center">
                            <span class="text-white font-bold">A</span>
                        </div>
                        <h1 class="text-2xl font-bold text-gray-800">Admin Panel</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-gray-600">Welcome, <span id="adminName" class="font-semibold"></span></span>
                        <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <div class="bg-white border-b">
            <div class="px-6 py-4">
                <div class="flex space-x-2 overflow-x-auto">
                    <button onclick="showTab('dashboard')" class="tab-button px-4 py-2 rounded-lg bg-blue-500 text-white">Dashboard</button>
                    <!-- --- NEW: Matching Tab Button --- -->
                    <button onclick="showTab('matching')" class="tab-button px-4 py-2 rounded-lg bg-gray-200 text-gray-700">Matching</button>
                    <button onclick="showTab('users')" class="tab-button px-4 py-2 rounded-lg bg-gray-200 text-gray-700">Users</button>
                    <button onclick="showTab('transactions')" class="tab-button px-4 py-2 rounded-lg bg-gray-200 text-gray-700">Transactions</button>
                    <button onclick="showTab('support')" class="tab-button px-4 py-2 rounded-lg bg-gray-200 text-gray-700">Support</button>
                    <button onclick="showTab('settings')" class="tab-button px-4 py-2 rounded-lg bg-gray-200 text-gray-700">Settings</button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="p-6">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content">
                <!-- ... existing dashboard html ... -->
            </div>

             <!-- --- NEW: Matching Tab Content --- -->
            <div id="matching" class="tab-content hidden">
                <h3 class="text-2xl font-bold text-gray-800 mb-6">Manual Matching</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Column 1: Providers -->
                    <div class="bg-white rounded-2xl shadow-sm p-6">
                        <h4 class="text-xl font-bold text-gray-800 mb-4">Pending Providers (ü§ù)</h4>
                        <div id="providersList" class="space-y-3 max-h-96 overflow-y-auto">
                            <!-- Provider requests will be loaded here -->
                        </div>
                    </div>
                    <!-- Column 2: Matching Controls -->
                    <div class="bg-white rounded-2xl shadow-sm p-6 flex flex-col items-center justify-center text-center">
                        <h4 class="text-xl font-bold text-gray-800 mb-4">Create Match</h4>
                        <div id="selectedProviderInfo" class="mb-4 h-12 text-sm"></div>
                        <div id="selectedGetterInfo" class="mb-6 h-12 text-sm"></div>
                        <button id="matchButton" onclick="createMatch()" disabled class="w-full bg-gray-400 cursor-not-allowed text-white py-3 rounded-lg font-semibold transition-colors">
                            Match Users
                        </button>
                        <p class="text-xs text-gray-500 mt-4">Select one user from each list to enable the match button.</p>
                    </div>
                    <!-- Column 3: Getters/Recipients -->
                    <div class="bg-white rounded-2xl shadow-sm p-6">
                        <h4 class="text-xl font-bold text-gray-800 mb-4">Pending Recipients (üôè)</h4>
                        <div id="gettersList" class="space-y-3 max-h-96 overflow-y-auto">
                             <!-- Getter requests will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="users" class="tab-content hidden">
                <!-- ... existing users html ... -->
            </div>

            <!-- Transactions Tab -->
            <div id="transactions" class="tab-content hidden">
                <!-- ... existing transactions html ... -->
            </div>

            <!-- Support Tab -->
            <div id="support" class="tab-content hidden">
                 <!-- ... existing support html ... -->
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content hidden">
                 <!-- ... existing settings html ... -->
            </div>
        </main>
    </div>
    <!-- Script tag and closing body/html tags -->
</body>
</html>
