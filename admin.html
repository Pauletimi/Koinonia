<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Koinonia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        // --- ADDED addDoc to imports for matching ---
        import { getFirestore, collection, getDocs, doc, setDoc, addDoc, updateDoc, deleteDoc, query, where, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC9ikNYt8QnD6FHm1MOq11HB0kTP_X8qNQ",
            authDomain: "wealth-club-65dab.firebaseapp.com",
            projectId: "wealth-club-65dab",
            storageBucket: "wealth-club-65dab.firebasestorage.app",
            messagingSenderId: "906138407714",
            appId: "1:906138407714:web:78e002acd44d2af326cb7b",
            measurementId: "G-8H8CZ65956"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentAdmin = null;
        let allUsers = [];
        let allTransactions = [];
        let allTickets = [];
        // --- NEW: Variables for the matching system ---
        let pendingProviders = [];
        let pendingGetters = [];
        let selectedProvider = null;
        let selectedGetter = null;

        // Check admin authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            const userData = localStorage.getItem('currentUser');
            const isAdmin = localStorage.getItem('isAdmin');
            
            if (!userData || !isAdmin || isAdmin !== 'true') {
                window.location.href = 'login.html';
                return;
            }

            currentAdmin = JSON.parse(userData);
            document.getElementById('adminName').textContent = currentAdmin.name;
            
            loadDashboardData();
            loadUsers(); // This now also loads users for matching
            loadTransactions();
            loadSupportTickets();
            initializeCharts();
            loadSystemSettings();
            loadHelpRequests();
        });

        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Load users
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const totalUsers = usersSnapshot.size;
                let activeUsers = 0;
                let totalInvestments = 0;

                usersSnapshot.forEach((doc) => {
                    const userData = doc.data();
                    if (userData.status === 'active') activeUsers++;
                    totalInvestments += userData.totalInvested || 0;
                });

                // Load transactions
                const transactionsSnapshot = await getDocs(collection(db, 'mavroTransactions'));
                const totalTransactions = transactionsSnapshot.size;

                // Load support tickets
                const ticketsSnapshot = await getDocs(collection(db, 'supportTickets'));
                let openTickets = 0;
                ticketsSnapshot.forEach((doc) => {
                    if (doc.data().status === 'open') openTickets++;
                });

                // Update dashboard
                document.getElementById('totalUsers').textContent = totalUsers;
                document.getElementById('activeUsers').textContent = activeUsers;
                document.getElementById('totalInvestments').textContent = `$${totalInvestments.toFixed(2)}`;
                document.getElementById('totalTransactions').textContent = totalTransactions;
                document.getElementById('openTickets').textContent = openTickets;

            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // --- UPDATED: Load users for both User Management tab and Matching Fallback ---
        async function loadUsers() {
            try {
                const querySnapshot = await getDocs(collection(db, 'users'));
                allUsers = [];
                
                querySnapshot.forEach((doc) => {
                    allUsers.push({ id: doc.id, ...doc.data() });
                });

                displayUsers(allUsers);
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Display users
        function displayUsers(users) {
            const container = document.getElementById('usersList');
            container.innerHTML = '';

            users.forEach(user => {
                const userElement = createUserElement(user);
                container.appendChild(userElement);
            });
        }

        // Create user element
        function createUserElement(user) {
            const div = document.createElement('div');
            div.className = 'bg-white border border-gray-200 rounded-lg p-6';
            
            const statusColor = user.status === 'active' ? 'green' : user.status === 'suspended' ? 'red' : 'yellow';
            
            div.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-1">${user.name}</h4>
                        <p class="text-gray-600 text-sm mb-2">${user.email}</p>
                        <p class="text-xs text-gray-500">Joined: ${new Date(user.joinDate).toLocaleDateString()}</p>
                        <p class="text-xs text-gray-500">Balance: $${(user.mavroBalance || 0).toFixed(2)}</p>
                    </div>
                    <div class="text-right">
                        <span class="inline-block px-3 py-1 text-sm rounded-full bg-${statusColor}-100 text-${statusColor}-800 mb-2">
                            ${user.status || 'pending'}
                        </span>
                        <div class="space-x-2">
                            <button onclick="editUser('${user.id}')" class="text-blue-600 hover:text-blue-800 text-sm">Edit</button>
                            <button onclick="suspendUser('${user.id}')" class="text-red-600 hover:text-red-800 text-sm">Suspend</button>
                        </div>
                    </div>
                </div>
            `;
            
            return div;
        }

        // Load transactions
        async function loadTransactions() {
            try {
                const querySnapshot = await getDocs(collection(db, 'mavroTransactions'));
                allTransactions = [];
                
                querySnapshot.forEach((doc) => {
                    allTransactions.push({ id: doc.id, ...doc.data() });
                });

                // Sort by date
                allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                displayTransactions(allTransactions);
            } catch (error) {
                console.error('Error loading transactions:', error);
            }
        }

        // Display transactions
        function displayTransactions(transactions) {
            const container = document.getElementById('transactionsList');
            container.innerHTML = '';

            transactions.slice(0, 10).forEach(transaction => {
                const transactionElement = createTransactionElement(transaction);
                container.appendChild(transactionElement);
            });
        }

        // Create transaction element
        function createTransactionElement(transaction) {
            const div = document.createElement('div');
            div.className = 'bg-white border border-gray-200 rounded-lg p-4';
            
            div.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <h4 class="font-semibold text-gray-800">${transaction.description}</h4>
                        <p class="text-gray-600 text-sm">${transaction.userName || 'Unknown User'}</p>
                        <p class="text-xs text-gray-500">${new Date(transaction.date).toLocaleDateString()}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-green-600">$${transaction.amount.toFixed(2)}</p>
                        <p class="text-xs text-gray-500">${transaction.type}</p>
                    </div>
                </div>
            `;
            
            return div;
        }

        // Load support tickets
        async function loadSupportTickets() {
            try {
                const querySnapshot = await getDocs(collection(db, 'supportTickets'));
                allTickets = [];
                
                querySnapshot.forEach((doc) => {
                    allTickets.push({ id: doc.id, ...doc.data() });
                });

                displaySupportTickets(allTickets);
            } catch (error) {
                console.error('Error loading support tickets:', error);
            }
        }

        // Display support tickets
        function displaySupportTickets(tickets) {
            const container = document.getElementById('ticketsList');
            container.innerHTML = '';

            tickets.forEach(ticket => {
                const ticketElement = createTicketElement(ticket);
                container.appendChild(ticketElement);
            });
        }

        // Create ticket element
        function createTicketElement(ticket) {
            const div = document.createElement('div');
            div.className = 'bg-white border border-gray-200 rounded-lg p-4';
            
            const statusColor = ticket.status === 'open' ? 'red' : ticket.status === 'resolved' ? 'green' : 'yellow';
            
            div.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <h4 class="font-semibold text-gray-800">${ticket.subject}</h4>
                        <p class="text-gray-600 text-sm">${ticket.userName}</p>
                        <p class="text-xs text-gray-500">${new Date(ticket.createdAt).toLocaleDateString()}</p>
                    </div>
                    <div class="text-right">
                        <span class="inline-block px-3 py-1 text-sm rounded-full bg-${statusColor}-100 text-${statusColor}-800 mb-2">
                            ${ticket.status}
                        </span>
                        <div>
                            <button onclick="resolveTicket('${ticket.id}')" class="text-green-600 hover:text-green-800 text-sm">Resolve</button>
                        </div>
                    </div>
                </div>
            `;
            
            return div;
        }

        // Initialize charts
        function initializeCharts() {
            // User Growth Chart
            const userCtx = document.getElementById('userGrowthChart').getContext('2d');
            new Chart(userCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'New Users',
                        data: [12, 19, 25, 32, 45, 67],
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });

            // Revenue Chart
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            new Chart(revenueCtx, {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Revenue',
                        data: [1200, 1900, 2500, 3200, 4500, 6700],
                        backgroundColor: 'rgba(34, 197, 94, 0.8)',
                        borderColor: 'rgb(34, 197, 94)',
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }
        
        // --- UPDATED: Functions for the Manual Matching System ---

        async function loadHelpRequests() {
            const requestsQuery = query(collection(db, 'helpRequests'), where('status', '==', 'pending'));
            const snapshot = await getDocs(requestsQuery);

            pendingProviders = [];
            pendingGetters = [];

            snapshot.forEach(doc => {
                const request = { id: doc.id, ...doc.data() };
                if (request.type === 'provide') {
                    pendingProviders.push(request);
                } else if (request.type === 'get') {
                    pendingGetters.push(request);
                }
            });
            displayHelpRequests();
        }
        
        // --- UPDATED: Display logic now includes a fallback to all users ---
        function displayHelpRequests() {
            const providersContainer = document.getElementById('providersList');
            const gettersContainer = document.getElementById('gettersList');
            const gettersTitle = document.getElementById('gettersTitle');
            providersContainer.innerHTML = '';
            gettersContainer.innerHTML = '';

            pendingProviders.forEach(req => {
                const reqElement = document.createElement('div');
                reqElement.id = `provider-${req.id}`;
                reqElement.className = 'border border-gray-200 p-3 rounded-lg cursor-pointer';
                reqElement.innerHTML = `<p class="font-semibold">${req.userName}</p><p class="text-green-600 font-bold">$${req.amount.toFixed(2)}</p>`;
                reqElement.onclick = () => selectProvider(req.id);
                providersContainer.appendChild(reqElement);
            });

            if (pendingGetters.length > 0) {
                gettersTitle.textContent = 'Pending Recipients (üôè)';
                pendingGetters.forEach(req => {
                    const reqElement = document.createElement('div');
                    reqElement.id = `getter-${req.id}`;
                    reqElement.className = 'border border-gray-200 p-3 rounded-lg cursor-pointer';
                    reqElement.innerHTML = `<p class="font-semibold">${req.userName}</p><p class="text-blue-600 font-bold">$${req.amount.toFixed(2)}</p>`;
                    reqElement.onclick = () => selectGetter(req.id);
                    gettersContainer.appendChild(reqElement);
                });
            } else {
                gettersTitle.textContent = 'All Users (Select a Recipient)';
                allUsers.forEach(user => {
                    const userElement = document.createElement('div');
                    userElement.id = `user-getter-${user.id}`;
                    userElement.className = 'border border-gray-200 p-3 rounded-lg cursor-pointer';
                    userElement.innerHTML = `<p class="font-semibold">${user.name}</p><p class="text-xs text-gray-500">${user.email}</p>`;
                    userElement.onclick = () => selectUserAsGetter(user.id);
                    gettersContainer.appendChild(userElement);
                });
            }
        }
        
        window.selectProvider = function(reqId) {
            selectedProvider = pendingProviders.find(p => p.id === reqId);
            document.getElementById('selectedProviderInfo').innerHTML = `<p><strong>Provider:</strong> ${selectedProvider.userName}</p><p><strong>Amount:</strong> <span class="text-green-600">$${selectedProvider.amount.toFixed(2)}</span></p>`;
            document.querySelectorAll('#providersList > div').forEach(div => div.classList.remove('ring-2', 'ring-green-500'));
            document.getElementById(`provider-${reqId}`).classList.add('ring-2', 'ring-green-500');
            checkMatchability();
        };

        window.selectGetter = function(reqId) {
            const getter = pendingGetters.find(g => g.id === reqId);
            selectedGetter = { ...getter, isManual: false }; // Mark as NOT manual
            document.getElementById('selectedGetterInfo').innerHTML = `<p><strong>Recipient:</strong> ${selectedGetter.userName}</p><p><strong>Amount:</strong> <span class="text-blue-600">$${selectedGetter.amount.toFixed(2)}</span></p>`;
            document.querySelectorAll('#gettersList > div').forEach(div => div.classList.remove('ring-2', 'ring-blue-500'));
            document.getElementById(`getter-${reqId}`).classList.add('ring-2', 'ring-blue-500');
            checkMatchability();
        };

        // --- NEW: Function to handle selecting a generic user as a getter ---
        window.selectUserAsGetter = function(userId) {
            const user = allUsers.find(u => u.id === userId);
            selectedGetter = { userId: user.id, userName: user.name, isManual: true }; // Mark as manual
            document.getElementById('selectedGetterInfo').innerHTML = `<p><strong>Recipient:</strong> ${selectedGetter.userName}</p><p><strong>Amount:</strong> <span class="text-blue-600">(From Provider)</span></p>`;
            document.querySelectorAll('#gettersList > div').forEach(div => div.classList.remove('ring-2', 'ring-blue-500'));
            document.getElementById(`user-getter-${userId}`).classList.add('ring-2', 'ring-blue-500');
            checkMatchability();
        }
        
        function checkMatchability() {
            const matchButton = document.getElementById('matchButton');
            if (selectedProvider && selectedGetter) {
                matchButton.disabled = false;
                matchButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                matchButton.classList.add('bg-purple-600', 'hover:bg-purple-700');
            } else {
                matchButton.disabled = true;
                matchButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                matchButton.classList.remove('bg-purple-600', 'hover:bg-purple-700');
            }
        }
        
        // --- UPDATED: Finalize the match, handles both request-based and manual getters ---
        window.createMatch = async function() {
            if (!selectedProvider || !selectedGetter) { alert("Please select both a provider and a recipient."); return; }

            const matchAmount = selectedGetter.isManual ? selectedProvider.amount : selectedGetter.amount;
            if (selectedProvider.amount < matchAmount) { alert("Provider's amount is less than the recipient's requested amount."); return; }
            if (!confirm(`Match ${selectedProvider.userName} ($${selectedProvider.amount}) with ${selectedGetter.userName} ($${matchAmount})?`)) { return; }

            try {
                let getterRequestId = selectedGetter.isManual ? null : selectedGetter.id;

                // If the getter was selected manually, create a help request for them first
                if (selectedGetter.isManual) {
                    const newRequestRef = await addDoc(collection(db, 'helpRequests'), {
                        userId: selectedGetter.userId,
                        userName: selectedGetter.userName,
                        type: 'get',
                        amount: matchAmount,
                        status: 'matched', // Immediately set to matched
                        createdAt: new Date().toISOString()
                    });
                    getterRequestId = newRequestRef.id;
                }

                await addDoc(collection(db, 'matches'), {
                    providerId: selectedProvider.userId,
                    providerName: selectedProvider.userName,
                    providerRequestId: selectedProvider.id,
                    getterId: selectedGetter.userId,
                    getterName: selectedGetter.userName,
                    getterRequestId: getterRequestId,
                    amount: matchAmount,
                    status: 'pending_payment',
                    createdAt: new Date().toISOString()
                });

                await updateDoc(doc(db, 'helpRequests', selectedProvider.id), { status: 'matched' });
                if (!selectedGetter.isManual) {
                    await updateDoc(doc(db, 'helpRequests', getterRequestId), { status: 'matched' });
                }
                
                alert("Match created successfully!");

                selectedProvider = null;
                selectedGetter = null;
                document.getElementById('selectedProviderInfo').innerHTML = '';
                document.getElementById('selectedGetterInfo').innerHTML = '';
                checkMatchability();
                loadHelpRequests();
            } catch (error) {
                console.error("Error creating match: ", error);
                alert("Failed to create match: " + error.message);
            }
        };

        // Load system settings
        async function loadSystemSettings() { /* ... existing code ... */ }
        // Save system settings
        window.saveSystemSettings = async function() { /* ... existing code ... */ };
        // Admin functions
        window.editUser = function(userId) { /* ... existing code ... */ };
        window.suspendUser = async function(userId) { /* ... existing code ... */ };
        async function updateUserBalance(userId, newBalance) { /* ... existing code ... */ }
        window.resolveTicket = async function(ticketId) { /* ... existing code ... */ };
        // Tab switching
        window.showTab = function(tabName) { /* ... existing code ... */ };
        // Search users
        window.searchUsers = function() { /* ... existing code ... */ };
        // Logout function
        window.logout = function() { /* ... existing code ... */ };
    </script>
</head>
<body>
    <div class="min-h-screen bg-gray-50">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
             <!-- ... existing header html ... -->
        </header>

        <!-- Tab Navigation -->
        <div class="bg-white border-b">
            <div class="px-6 py-4">
                <div class="flex space-x-4 overflow-x-auto pb-2">
                    <button onclick="showTab('dashboard')" class="tab-button px-4 py-2 rounded-lg bg-blue-500 text-white">Dashboard</button>
                    <button onclick="showTab('matching')" class="tab-button px-4 py-2 rounded-lg bg-gray-200 text-gray-700">Matching</button>
                    <button onclick="showTab('users')" class="tab-button px-4 py-2 rounded-lg bg-gray-200 text-gray-700">Users</button>
                    <button onclick="showTab('transactions')" class="tab-button px-4 py-2 rounded-lg bg-gray-200 text-gray-700">Transactions</button>
                    <button onclick="showTab('support')" class="tab-button px-4 py-2 rounded-lg bg-gray-200 text-gray-700">Support</button>
                    <button onclick="showTab('settings')" class="tab-button px-4 py-2 rounded-lg bg-gray-200 text-gray-700">Settings</button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="p-6">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content">
                 <!-- ... existing dashboard html ... -->
            </div>
            
            <!-- --- UPDATED: Matching Tab Content --- -->
            <div id="matching" class="tab-content hidden">
                <h3 class="text-2xl font-bold text-gray-800 mb-6">Manual Matching</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Column 1: Providers -->
                    <div class="bg-white rounded-2xl shadow-sm p-6">
                        <h4 class="text-xl font-bold text-gray-800 mb-4">Pending Providers (ü§ù)</h4>
                        <div id="providersList" class="space-y-3 max-h-96 overflow-y-auto">
                            <!-- Provider requests will be loaded here -->
                        </div>
                    </div>
                    <!-- Column 2: Matching Controls -->
                    <div class="bg-white rounded-2xl shadow-sm p-6 flex flex-col items-center justify-center text-center">
                        <h4 class="text-xl font-bold text-gray-800 mb-4">Create Match</h4>
                        <div id="selectedProviderInfo" class="mb-4 h-12 text-sm"></div>
                        <div id="selectedGetterInfo" class="mb-6 h-12 text-sm"></div>
                        <button id="matchButton" onclick="createMatch()" disabled class="w-full bg-gray-400 cursor-not-allowed text-white py-3 rounded-lg font-semibold transition-colors">
                            Match Users
                        </button>
                        <p class="text-xs text-gray-500 mt-4">Select one user from each list to enable the match button.</p>
                    </div>
                    <!-- Column 3: Getters/Recipients -->
                    <div class="bg-white rounded-2xl shadow-sm p-6">
                        <h4 id="gettersTitle" class="text-xl font-bold text-gray-800 mb-4">Pending Recipients (üôè)</h4>
                        <div id="gettersList" class="space-y-3 max-h-96 overflow-y-auto">
                             <!-- Getter requests or all users will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="users" class="tab-content hidden">
                <!-- ... existing users html ... -->
            </div>

            <!-- Transactions Tab -->
            <div id="transactions" class="tab-content hidden">
                 <!-- ... existing transactions html ... -->
            </div>

            <!-- Support Tab -->
            <div id="support" class="tab-content hidden">
                <!-- ... existing support html ... -->
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content hidden">
                 <!-- ... existing settings html ... -->
            </div>
        </main>
    </div>
    <!-- Script tag and closing body/html tags -->
</body>
</html>
